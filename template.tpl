___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.

___INFO___

{
  "displayName": "LiquidM Universal Pixel",
  "description": "This pixel allows you to attribute conversions to campaigns and ads, run CPC+ campaigns and build audiences for retargeting. The description of attribution models is available in Platform Guide.",
  "categories": ["ATTRIBUTION", "CONVERSION_TRACKING", "REMARKETING"],
  "securityGroups": [],
  "id": "cvt_temp_public_id",
  "type": "TAG",
  "version": 1,
  "brand": {
    "thumbnail": "data:image/png;base64,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",
    "displayName": "LiquidM DSP",
    "id": "brand_dummy"
  },
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "alwaysInSummary": true,
    "selectItems": [
      {
        "displayValue": "CPC+ Complete View Tracking",
        "value": "cpcp"
      },
      {
        "displayValue": "Conversion Tracking",
        "value": "conversion"
      },
      {
        "displayValue": "Retargeting Segments",
        "value": "retargeting"
      }
    ],
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "displayName": "Pixel Type",
    "defaultValue": "cpcp",
    "simpleValueType": true,
    "name": "pixelType",
    "type": "SELECT"
  },
  {
    "alwaysInSummary": true,
    "selectItems": [
      {
        "displayValue": "Conversion #1",
        "value": 1
      },
      {
        "displayValue": "Conversion #2",
        "value": 2
      },
      {
        "displayValue": "Conversion #3",
        "value": 3
      }
    ],
    "enablingConditions": [
      {
        "paramName": "pixelType",
        "type": "EQUALS",
        "paramValue": "conversion"
      }
    ],
    "displayName": "Conversion ID",
    "defaultValue": 1,
    "simpleValueType": true,
    "name": "conversionID",
    "type": "SELECT"
  },
  {
    "help": "Please refer to the LiquidM Platform Guide documentation for use case examples, the description of the attribution models and limitations of each attribution type.",
    "alwaysInSummary": true,
    "selectItems": [
      {
        "displayValue": "Deferred Tracking (1st party cookies)",
        "value": "deferred"
      },
      {
        "displayValue": "Click Token (1st party cookies)",
        "value": "clicktoken"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "pixelType",
        "type": "EQUALS",
        "paramValue": "conversion"
      }
    ],
    "displayName": "Attribution Type",
    "defaultValue": "deferred",
    "simpleValueType": true,
    "name": "attributionType",
    "type": "SELECT"
  },
  {
    "notSetText": "Please copy-paste the segment token from LiquidM platform",
    "clearOnCopy": true,
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "pixelType",
        "type": "EQUALS",
        "paramValue": "retargeting"
      }
    ],
    "displayName": "Segment Token",
    "simpleValueType": true,
    "name": "segmentToken",
    "type": "TEXT"
  },
  {
    "help": "Select 'Retrieve the Consent from CMP' when you integrated IAB TCF v1 compliant Consent Management Platform (CMP). \nSelect 'Without Consent' if you have obtained the consent in a different form and can limit the execution of the pixel only to the users who provided the consent.",
    "selectItems": [
      {
        "displayValue": "Without Consent",
        "value": "none"
      },
      {
        "displayValue": "Retrieve the Consent from CMP",
        "value": "cmp"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "pixelType",
        "type": "EQUALS",
        "paramValue": "conversion"
      },
      {
        "paramName": "pixelType",
        "type": "EQUALS",
        "paramValue": "retargeting"
      }
    ],
    "displayName": "Consent Type",
    "defaultValue": "none",
    "simpleValueType": true,
    "name": "consentType",
    "type": "SELECT"
  }
]


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "__cmp"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_referrer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryKeys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "lqmclid"
              }
            ]
          }
        },
        {
          "key": "query",
          "value": {
            "type": 8,
            "boolean": true
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "lqmclid"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://tracking.lqm.io/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "lqmclid"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryKeys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "lqmclid"
              }
            ]
          }
        },
        {
          "key": "query",
          "value": {
            "type": 8,
            "boolean": true
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://tracking.lqm.io/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole'),
    query = require('queryPermission'),
    random = require('generateRandom'),
    _encodeUriComponent = require('encodeUriComponent'),
    encodeUriComponent = function(val) {
        return _encodeUriComponent(val.toString());
    },
    getTimestamp = require('getTimestamp'),
    callInWindow = require('callInWindow'),
    getQueryParameters = require('getQueryParameters'),
    getReferrerQueryParameters = require('getReferrerQueryParameters'),
    getCookie = require('getCookieValues'),
    setCookie = require('setCookie'),
    sendPixel = require('sendPixel'),
    injectScript = require('injectScript');


log('LQM universal pixel v1.10');
let msg = 'data: ';
for (let i in data) msg += '\n' + i + ': ' + data[i];
log(msg);


if (data.pixelType === 'conversion') {
    executeWithConsent(executeConversion);
} else if (data.pixelType === 'retargeting') {
    executeWithConsent(executeRetargeting);
} else if (data.pixelType === 'cpcp') {
    executeCompleteView();
} else {
    log('unknown pixel type');
    data.gtmOnFailure();
}

function executeWithConsent(callback) {
    if (data.consentType === 'none') {
        callback('', '');
    } else if (data.consentType === 'cmp') {
        log('requesting cmp for the consent...');
        callInWindow('__cmp', "getConsentData", null, function (val, success) {
            let GDPR = '', GDPR_CONSENT = '';
            if (success) {
                log('data from cmp: ' + val);
                if (val.gdprApplies) {
                    GDPR = '1';
                }
                if (val.consentData) {
                    GDPR_CONSENT = val.consentData;
                }
                callback(GDPR, GDPR_CONSENT);
            } else {
                log('failed to receive consent information from cmp: ' + val);
                data.gtmOnFailure();
            }
        });
    } else {
        log('unknown consent type');
        data.gtmOnFailure();
    }
}

function executeConversion(gdpr, consent) {
    if (data.attributionType === 'deferred') {
        let token = readToken();
        if (token) writeToken(token);
        data.gtmOnSuccess();
    } else if (data.attributionType === 'clicktoken') {
        let token = readToken();
        if (typeof token !== 'undefined' && token !== '') {
            writeToken(token);
            firePixel('https://tracking.lqm.io/conversion/' + encodeUriComponent(token) + '/t.gif?' +
                'conversion_id=' + encodeUriComponent(data.conversionID) +
                '&gdpr=' + encodeUriComponent(gdpr) + '&gdpr_consent=' + encodeUriComponent(consent) + '&cb=' + getTimestamp());
        } else {
            log('token is not found');
            data.gtmOnFailure();
        }
    } else {
        log('unknown attribution type');
        data.gtmOnFailure();
    }
}

function executeRetargeting(gdpr, consent) {
    const url = 'https://tracking.lqm.io/odin/handle_sync.js?seg=' + encodeUriComponent(data.segmentToken) +
        '&gdpr=' + encodeUriComponent(gdpr) + '&gdpr_consent=' + encodeUriComponent(consent) + '&cb=' + getTimestamp();
    log('url: ' + url);
    if (!data.segmentToken) {
        log('empty segment token');
        data.gtmOnFailure();
    } else if (query('inject_script', url)) {
        log('injecting script');
        injectScript(url, data.gtmOnSuccess, data.gtmOnFailure);
    } else {
        log('no permission to inject the script');
        data.gtmOnFailure();
    }
}

function executeCompleteView() {
    let lqmclid = readToken();
    if (typeof lqmclid !== 'undefined' && lqmclid !== '') {
        writeToken(lqmclid);
        firePixel('https://tracking.lqm.io/odin/complete_view/' + encodeUriComponent(lqmclid.toString()) +
            '?cb=' + getTimestamp());
    } else {
        log('nothing to report');
        data.gtmOnSuccess();
    }
}

function firePixel(url) {
    if (query('send_pixel', url)) {
        log('firing pixel: ' + url);
        sendPixel(url, data.gtmOnSuccess, data.gtmOnFailure);
    } else {
        log('no permission to fire pixel');
        data.gtmOnFailure();
    }
}

function readToken() {
    let paramName = 'lqmclid',
        lqmclid = '';
    if (query('get_url', 'query', paramName)) {
        log('checking lqmclid in query');
        lqmclid = getQueryParameters(paramName);
    }
    if ((typeof lqmclid === 'undefined' || lqmclid === '') && query('get_referrer', 'query', paramName)) {
        log('checking lqmclid in referrer');
        lqmclid = getReferrerQueryParameters(paramName);
    }
    if ((typeof lqmclid === 'undefined' || lqmclid === '') && query('get_cookies', paramName)) {
        log('checking lqmclid in cookies');
        lqmclid = getCookie(paramName);
        lqmclid = (lqmclid && lqmclid.length) ? lqmclid[0] : undefined;
    }
    log('lqmclid: ' + lqmclid);
    return lqmclid;
}

function writeToken(token) {
    let paramName = 'lqmclid',
        cookieOptions = {domain: 'auto', path: '/', 'max-age': 60 * 60 * 24 * 30, secure: true};
    if (query('set_cookies', paramName, cookieOptions)) {
        log('storing to cookie');
        setCookie(paramName, token, cookieOptions);
    } else {
        log('no permission to set cookie');
    }
}


___NOTES___

Created on 9/20/2019, 11:27:22 AM
